(()=>{"use strict";var e={63:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PolicySettings=void 0;const n=i(255);t.PolicySettings=class{constructor(e){if(this.ignoredNamespaces=e.ignoredNamespaces||[],this.testScenario=e.testScenario,this.testScenario&&!["oci-manifest-digest-success","oci-manifest-digest-failure","dns-lookup-success","dns-lookup-failure","oci-manifest-success","oci-manifest-failure"].includes(this.testScenario))throw new Error(`Unknown testScenario: ${this.testScenario}`)}validate(){return new n.Validation.SettingsValidationResponse(!0)}}},118:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Network=void 0;const n=i(348);var o;!function(e){e.DnsLookupResponse=class{constructor(e){this.ips=e}},e.dnsLookup=function(e){const t=(new TextEncoder).encode(JSON.stringify(e)),i=n.HostCall.hostCall("kubewarden","net","v1/dns_lookup_host",t.buffer),o=(new TextDecoder).decode(i);return JSON.parse(o)}}(o||(t.Network=o={}))},233:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Manifest=void 0;const n=i(348),o=i(711);var s;!function(e){e.getOCIManifest=function(e){let t;try{t=(new TextEncoder).encode(JSON.stringify(e)).buffer}catch(e){throw new Error(`Cannot serialize image to JSON: ${e}`)}const i=n.HostCall.hostCall("kubewarden","oci","v1/oci_manifest",t);try{const e=(new TextDecoder).decode(i);return o.OciImageManifestResponse.fromJSON(e)}catch(e){throw new Error(`Cannot parse response: ${e}`)}}}(s||(t.Manifest=s={}))},255:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Validation=void 0;const n=i(629);var o;!function(e){e.SettingsValidationResponse=class{constructor(e,t){this.valid=e,this.message=t}};class t{constructor(e,t,i,n,o,s){this.accepted=e,this.message=t,this.code=i,this.mutated_object=n,this.audit_annotations=o,this.warnings=s}}e.ValidationResponse=t,e.ValidationRequest=class{constructor(e,t){this.request=e,this.settings=t}},e.acceptRequest=function(){return new t(!0)},e.rejectRequest=function(e,i){return new t(!1,e,i)},e.readValidationRequest=function(){const e=(new TextDecoder).decode((0,n.readInput)());return JSON.parse(e)}}(o||(t.Validation=o={}))},348:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HostCall=void 0;const n=i(629);var o;!function(e){e.hostCall=function(e,t,i,o){const s=__hostCall(e,t,i,o),a=(0,n.readInput)();if(!s){const e=new TextDecoder("utf-8").decode(a);throw console.error("Host call failed: ",e),new Error("Host call failed")}return a}}(o||(t.HostCall=o={}))},375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MediaTypeImageLayer=t.MediaTypeDescriptor=t.MediaTypeImageConfig=t.MediaTypeImageManifest=t.MediaTypeImageIndex=void 0,t.MediaTypeImageIndex="application/vnd.oci.image.index.v1+json",t.MediaTypeImageManifest="application/vnd.oci.image.manifest.v1+json",t.MediaTypeImageConfig="application/vnd.oci.image.config.v1+json",t.MediaTypeDescriptor="application/vnd.oci.descriptor.v1+json",t.MediaTypeImageLayer="application/vnd.oci.image.layer.v1.tar+gzip"},389:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.handleOciManifestDigestSuccess=function(){const e=s.ManifestDigest.getOCIManifestDigest("docker.io/library/busybox:1.36");return new a.Validation.ValidationResponse(!!e,e?void 0:"Failed to retrieve OCI manifest digest",void 0,void 0,{digest:e||""})},t.handleOciManifestDigestFailure=function(){const e=s.ManifestDigest.getOCIManifestDigest("registry.testing.lan/nonexistent-image:1.0.0");return new a.Validation.ValidationResponse(!e,"Unexpectedly succeeded in manifest digest lookup",void 0,void 0,{digest:e||""})},t.handleDnsLookupSuccess=function(){const e=n.Network.dnsLookup("google.com").ips;return new a.Validation.ValidationResponse(!!e&&e.length>0,e&&e.length>0?void 0:"Failed to retrieve DNS lookup IPs",void 0,void 0,{ips:e.join(", ")||""})},t.handleDnsLookupFailure=function(){const e=n.Network.dnsLookup("invalid.nonexistent.tld").ips;return new a.Validation.ValidationResponse(!1,"Unexpectedly retrieved DNS lookup IPs",void 0,void 0,{ips:e.join(", ")})},t.handleOciManifestSuccess=function(){const e=o.Manifest.getOCIManifest("docker.io/library/busybox:1.36");return new a.Validation.ValidationResponse(!!e,e?void 0:"Failed to retrieve OCI manifest",void 0,void 0,{manifest:e?JSON.stringify(e):""})},t.handleOciManifestFailure=function(){const e=o.Manifest.getOCIManifest("example.test/nonexistent-image:1.0.0");return new a.Validation.ValidationResponse(!e,"Unexpectedly succeeded in manifest lookup",void 0,void 0,{manifest:""})},t.handlePrivilegedContainerValidation=function(e,t){if(t.ignoredNamespaces?.includes(e.request.namespace||""))return console.error("Privileged containers are allowed inside of ignored namespace"),a.Validation.acceptRequest();const i=JSON.parse(JSON.stringify(e.request.object));return i.spec?.containers?.some(e=>e.securityContext?.privileged)?a.Validation.rejectRequest("privileged containers are not allowed"):a.Validation.acceptRequest()};const n=i(118),o=i(233),s=i(709),a=i(255)},629:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.readInput=function(){const e=[];let t=0;for(;;){const i=new Uint8Array(1024),n=0,o=Javy.IO.readSync(n,i);if(t+=o,0===o)break;e.push(i.subarray(0,o))}const{finalBuffer:i}=e.reduce((e,t)=>(e.finalBuffer.set(t,e.bufferOffset),e.bufferOffset+=t.length,e),{finalBuffer:new Uint8Array(t),bufferOffset:0});return i},t.writeOutput=function(e){const t=(new TextEncoder).encode(JSON.stringify(e)),i=new Uint8Array(t);Javy.IO.writeSync(1,i)}},645:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.constants=void 0,t.constants={ProtocolVersion:"v1",ImageManifestListMediaType:"application/vnd.docker.distribution.manifest.list.v2+json",ImageManifestMediaType:"application/vnd.docker.distribution.manifest.v2+json"}},709:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestDigest=void 0;const n=i(348);var o;!function(e){e.getOCIManifestDigest=function(e){let t;try{t=(new TextEncoder).encode(JSON.stringify(e)).buffer}catch(e){throw new Error(`Cannot serialize image to JSON: ${e}`)}const i=n.HostCall.hostCall("kubewarden","oci","v1/manifest_digest",t);let o;try{const e=(new TextDecoder).decode(i);o=JSON.parse(e)}catch(e){throw new Error(`Cannot parse response: ${e}`)}return o.digest}}(o||(t.ManifestDigest=o={}))},711:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OciImageManifestResponse=void 0;const n=i(645),o=i(375);class s{constructor(e){this.manifest=e}static fromJSON(e){try{const i=JSON.parse(e);if("image"in i){const e=i.image;if(e.mediaType&&((t=e.mediaType)===o.MediaTypeImageManifest||t===n.constants.ImageManifestMediaType))return new s({kind:"image",image:e})}if("index"in i){const e=i.index;if(e.mediaType&&function(e){return e===o.MediaTypeImageIndex||e===n.constants.ImageManifestListMediaType}(e.mediaType))return new s({kind:"index",index:e})}throw new Error("Cannot decode response")}catch{throw new Error("Cannot decode response")}var t}imageManifest(){return"image"===this.manifest.kind?this.manifest.image:void 0}indexManifest(){return"index"===this.manifest.kind?this.manifest.index:void 0}}t.OciImageManifestResponse=s}},t={};function i(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}(()=>{const e=i(255),t=i(629),n=i(63),o=i(389);try{const i=policyAction();switch(console.error("Action:",i),i){case"validate":!function(){const i=e.Validation.readValidationRequest(),n=i.settings;let s;switch(console.error("Settings:",JSON.stringify(n)),n.testScenario){case"oci-manifest-digest-success":s=(0,o.handleOciManifestDigestSuccess)();break;case"oci-manifest-digest-failure":s=(0,o.handleOciManifestDigestFailure)();break;case"dns-lookup-success":s=(0,o.handleDnsLookupSuccess)();break;case"dns-lookup-failure":s=(0,o.handleDnsLookupFailure)();break;case"oci-manifest-success":s=(0,o.handleOciManifestSuccess)();break;case"oci-manifest-failure":s=(0,o.handleOciManifestFailure)();break;default:s=(0,o.handlePrivilegedContainerValidation)(i,n)}(0,t.writeOutput)(s)}();break;case"validate-settings":!function(){try{const i=e.Validation.readValidationRequest(),o=new n.PolicySettings(i).validate();(0,t.writeOutput)(o)}catch(i){console.error("validateSettings error:",i);const n=new e.Validation.SettingsValidationResponse(!1,`${i}`);(0,t.writeOutput)(n)}}();break;default:{console.error("Unknown action:",i);const n=new e.Validation.ValidationResponse(!1,"wrong invocation");(0,t.writeOutput)(n)}}}catch(i){console.error("error:",i);const n=new e.Validation.ValidationResponse(!1,"wrong invocation");(0,t.writeOutput)(n)}})()})();